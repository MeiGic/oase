<br>
<br>
<div class="container col-lg-10 col-lg-offset-1">
	<div id="nothing" class="jumbotron">
		<h2>這裡是空的</h2>
		<a class="btn btn-lg btn-danger" href="#productlist" role="button">馬上買一杯！</a>
	</div>
	<div id="orderdiv">
		<div class="panel panel-default">
			<table id="ordertable" class="table table-responsive table-hover text-center footable toggle-circle-filled">      
				<thead class="text-center">
					<th>飲品</th>
					<th>大小</th>
					<th data-hide="phone">甜度</th>
					<th data-hide="phone">冰塊</th>
					<th data-hide="phone">加料</th>
					<th>數量</th>
					<th>價格</th>
					<th></th>
				</thead>
				<tbody>
		
				<!-- <tr>
				<td>珍珠奶茶</td>
				<td>大杯</td>
				<td>半糖</td>
				<td>少冰</td>
				<td>粉條</td>
				<td>1</td>
				<td>$40</td>
				<td><p><a class="text-danger row-delete" style="cursor: pointer;" data-toggle="modal" data-target="#delete"><i class="fa fa-times-circle"></i></a></p></td>
				</tr>
				
				<tr>
				<td>珍珠奶茶</td>
				<td>大杯</td>
				<td>半糖</td>
				<td>少冰</td>
				<td></td>
				<td>1</td>
				<td>$40</td>
				<td><p><a class="text-danger row-delete" style="cursor: pointer;" data-toggle="modal" data-target="#delete"><i class="fa fa-times-circle"></i></a></p></td>
				</tr>
				
				<tr>
				<td>珍珠奶茶</td>
				<td>大杯</td>
				<td>半糖</td>
				<td>少冰</td>
				<td></td>
				<td>1</td>
				<td>$40</td>
				<td><p><a class="text-danger row-delete" style="cursor: pointer;" data-toggle="modal" data-target="#delete"><i class="fa fa-times-circle"></i></a></p></td>
				</tr> -->
				
				</tbody>
			</table>	
			<div class="panel-footer text-right">
				<span class="label label-primary">總計：<span id="count">0</span>杯</span>
				<span class="label label-danger">小計：NTD$<span id="sum">0</span></span>
				<a type="button" id="loginfirst" class="btn btn-success" href="#login">結帳請先登入 <i class="fa fa-chevron-circle-right"></i></a>
				<button type="button" id="checkoutnow" class="btn btn-success" data-toggle="modal" data-target="#order">結帳 <i class="fa fa-chevron-circle-right"></i></button>
			</div>
		</div>
	</div>
	<div id="recorddiv">
		<div class="row text-center">
			<h2>歷史</h2>
		</div>
		<div class="panel panel-default">
			<table id="recordtable" class="table table-hover text-center footable toggle-circle-filled">      
				<thead class="text-center">
					<th>飲品</th>
					<th>大小</th>
					<th data-hide="phone">甜度</th>
					<th data-hide="phone">冰塊</th>
					<th data-hide="phone">加料</th>
					<th>數量</th>
					<th>價格</th>
					<th></th>
				</thead>
				<tbody>
		
				<!-- <tr>
				<td>珍珠奶茶</td>
				<td>大杯</td>
				<td>半糖</td>
				<td>少冰</td>
				<td>粉條</td>
				<td>1</td>
				<td>$40</td>
				<td><p><a class="text-success" style="cursor: pointer;" data-placement="top" rel="tooltip" title="已送達"><i class="fa fa-check"></i></a></p></td>
				</tr>
				
				<tr>
				<td>珍珠奶茶</td>
				<td>大杯</td>
				<td>半糖</td>
				<td>少冰</td>
				<td></td>
				<td>1</td>
				<td>$40</td>
				<td><p><a class="text-primary" style="cursor: pointer;" data-placement="top" rel="tooltip" title="配送中"><i class="fa fa-truck"></i></a></p></td>
				</tr>
				
				<tr>
				<td>珍珠奶茶</td>
				<td>大杯</td>
				<td>半糖</td>
				<td>少冰</td>
				<td></td>
				<td>1</td>
				<td>$40</td>
				<td><p><a class="text-warning" style="cursor: pointer;" data-placement="top" rel="tooltip" title="製作中"><i class="fa fa-tasks"></i></a></p></td>
				</tr> -->
				
				</tbody>
			</table>
		</div>
	</div>
</div>
    
<div class="modal fade" id="delete" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
    <div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h4 class="modal-title custom_align" id="Heading">取消訂單</h4>
			</div>
			<div class="modal-body">
				<h4><i class="fa fa-exclamation-circle"></i> 你確定要取消此筆訂單嗎？</h4>
				<div id="deleterowdetail"></div>
			</div>
			<div class="modal-footer">
				<button type="button" id="confirmrowdelete" class="btn btn-danger" data-dismiss="modal">確定</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
			</div>
		</div>
	<!-- /.modal-content --> 
	</div>
<!-- /.modal-dialog --> 
</div>

<div class="modal fade" id="order" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
    <div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h4 class="modal-title custom_align" id="Heading">結帳</h4>
			</div>
			<div class="modal-body">
				<h4><i class="fa fa-info-circle"></i> 請填寫以下資訊完成結帳</h4>
				<h4>您的電話：<h4>
				<div class="btn-group-vertical" data-toggle="buttons" id="phone">
				  <label class="btn btn-primary active">
					<input type="radio" name="phone"> 來自帳號資訊： <strong>0911-111-123</strong>
				  </label>
				  <label class="btn btn-primary">
					<input type="radio" name="phone"> 手動填寫： <input type="text" class="form-control" placeholder="您的電話">
				  </label>
				</div>
				<h4>寄送地址：<h4>
				<div class="btn-group-vertical" data-toggle="buttons" id="address">
				  <label class="btn btn-warning active">
					<input type="radio" name="address"> 來自帳號資訊： <strong>台北市忠孝東路三段1號4樓</strong>
				  </label>
				  <label class="btn btn-warning">
						<input type="radio" name="address"> 店鋪取貨： 
						<div class="form-group">
							<select type="text" id="storedropdown" class="form-control select2" data-placeholder="請選擇" placeholder="請選擇" tabindex="3">
								<option></option>
							</select>
						</div>
				  </label>
				  <label class="btn btn-warning">
						<input type="radio" name="address"> 手動填寫： <input type="text" class="form-control" placeholder="您的地址">
				  </label>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" id="confirmorder" class="btn btn-success" data-dismiss="modal">完成！</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
			</div>
		</div>
	<!-- /.modal-content --> 
	</div>
<!-- /.modal-dialog --> 
</div>

<script>
$.get( "http://www.meigic.tw/oase/check.php", {sessionid:$.cookie('PHPSESSID'), type:"isloggedin"}, function(data) {
	$("#loginfirst").hide();
	$("#checkoutnow").hide();
	if(data == 0) {
		$("#loginfirst").show();
	} else {
		$("#checkoutnow").show();
	}
});
$.getJSON("http://www.meigic.tw/oase/go.php", {type:"storelist"}, function(data) {
	$.each(data.result, function(key, val) {
		$("#storedropdown").append($("<option></option>").attr("value", val.u_id).text(val.u_name));
	});
	$("#storedropdown").select2({
		minimumResultsForSearch: -1,
	});
});
$('[rel="tooltip"]').tooltip();
$("#ordertable").footable();
$("#recordtable").footable();
$("#nothing").hide();
$("#orderdiv").hide();
$("#recorddiv").hide();
updateTable("#recordtable", "#recorddiv");
$('table').footable().on('click', '.row-delete', function(e) {
    e.preventDefault();
    //get the footable object
    var footable = $('table').data('footable');

    //get the row we are wanting to delete
    var row = $(this).parents('tr:first');
	
	var thead = $("#ordertable thead:first").html();
	
	var deletedetail = "";
	$(row).children('td').each(function(i) {
		if(i < 6) {
			deletedetail += "<strong>" + $(thead).children("th").eq(i).html() + ": </strong>";
			deletedetail += $(this).text() + "<br>";
		}
	});
	
	$("#deleterowdetail").html(deletedetail);
	
	$('#confirmrowdelete').off("click").click(function() {
		var url = "http://www.meigic.tw/oase/shopcart.php?type=remove_temp_order&index=" + row[0].rowIndex;
		if($.cookie('PHPSESSID') != undefined && $.cookie('PHPSESSID') != '')
			url += "&sessionid=" + $.cookie('PHPSESSID');
		$.get( url, function(data) {
			var info = data.split(":");
				if(info[0] == "success") {
					$.cookie('PHPSESSID', info[1], { path: '/' });
				}
		});
	
		$(row).find('td')
			.wrapInner('<div style="display: block;" />')
			.parent()
			.find('td > div')
			.slideUp(function(){
			
			//delete the row
			footable.removeRow(row);
			
			updateTable("#ordertable", "#orderdiv", function(hide) {
				if(hide)
					$("#nothing").slideDown();
				else
					$("#nothing").hide();
			});
			updateTable("#recordtable", "#recorddiv");
			updateOrderInfo();
			ajaxload("#header", "ajax/header.html");
		});
	});
});
function updateTable(tableid, divid, onCompleteEvent) {
	if($(tableid + " tr").length <= 1) {
		$(divid).slideUp();
		if(onCompleteEvent)
			onCompleteEvent(true);
	} else {
		$(divid).slideDown();
		if(onCompleteEvent)
			onCompleteEvent(false);
	}
}
function updateOrderInfo() {
	var count = 0;
	var sum = 0;
	$("#ordertable tr").each(function() {
		if($.isNumeric(count)) {
			count += +($(this).children('td:eq(5)').text());
			sum += +($(this).children('td:eq(6)').text().substring(1));
		}
	});
	$("#count").html(count);
	$("#sum").html(sum);
}
getspecialorderlist();
var specialorderlist = [];
function getspecialorderlist() {
	$.getJSON("http://www.meigic.tw/oase/go.php", {type:"specialorderlist"}, function(data) {
		specialorderlist = data.result;
		getproductlist();
	});
}
var productlist = [];
function getproductlist() {
	$.getJSON("http://www.meigic.tw/oase/go.php", {type:"productlist"}, function(data) {
		productlist = data.result;
		getorderlist();
	});
}
function getorderlist() {
	$.getJSON("http://www.meigic.tw/oase/shopcart.php", {sessionid:$.cookie('PHPSESSID'), type:"get_temp_order"}, function(data) {
		//get the footable object
		var footable = $('#ordertable').data('footable');
		var orderdata = data;
		if(orderdata.length > 0 && productlist.length > 0 && specialorderlist.length > 0) {
			$.each(orderdata, function(key, val) {
				var matchproduct;
				for(var i = 0; i < productlist.length; i++) {
					if(productlist[i].p_id == val.p_id) {
						matchproduct = productlist[i];
						break;
					}
				}
				if(typeof matchproduct != 'undefined') {
					var productname = matchproduct.p_name;
					var productprice = +(matchproduct.price);
					var size = val.size;
					var sweet = +(val.sweet);
					var temp = +(val.temp);
					var specialorderarray = val.so_id.split(',');
					var matchspecialorderlist = [];
					var specialorderstring = [];
					var specialorderprice = 0;
					$.each(specialorderarray, function(index, so_id) {
						for(var i = 0; i < specialorderlist.length; i++) {
							if(specialorderlist[i].so_id == so_id) {
								matchspecialorderlist.push(specialorderlist[i]);
								specialorderstring.push(specialorderlist[i].so_name);
								specialorderprice += +(specialorderlist[i].price);
								break;
							}
						}
					});
					specialorderstring = specialorderstring.join("、");
					var count = +(val.count);
					var sum = (productprice + specialorderprice) * count;
					
					var sizestringarray = {S:"小杯",M:"中杯",L:"大杯"};
					var sweetstringarray = ["無糖","微糖","半糖","少糖","全糖"];
					var tempstringarray = ["去冰","微冰","半冰","少冰","全冰"];
					
					var neworder = '<tr><td>' + productname + '</td><td>' + sizestringarray[size] + '</td><td>' + sweetstringarray[sweet - 1] + '</td><td>' + tempstringarray[temp - 1] + '</td><td>' + specialorderstring + '</td><td>' + count + '</td><td>$' + sum + '</td><td><p><a class="text-danger row-delete" style="cursor: pointer;" data-toggle="modal" data-target="#delete"><i class="fa fa-times-circle"></i></a></p></td></tr>';
					//console.log(neworder);
					//orderlist.push(neworder);
					footable.appendRow(neworder);
				}
			});
		}
		updateOrderInfo();
		updateTable("#ordertable", "#orderdiv", function(hide) {
			if(hide)
				$("#nothing").slideDown();
			else
				$("#nothing").hide();
		});
	});
}
</script>